<!DOCTYPE html><html><head>
<title>SD Proxy</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0d1a0d;--card:#142014;--border:#2d4a2d;--text:#c8d6c8;--muted:#6b8e6b;--accent:#4ade80;--danger:#e94560}
body{font-family:-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:10px;font-size:13px}
.container{max-width:1400px;margin:0 auto}
h1{color:var(--accent);font-size:18px;margin-bottom:8px;display:flex;align-items:center;gap:10px}
h3{color:var(--accent);font-size:14px;margin-bottom:8px}
.tabs{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;justify-content:center}
.tab{padding:6px 12px;background:#1a2e1a;border:1px solid var(--border);color:var(--muted);cursor:pointer;border-radius:4px;font-size:12px}
.tab:hover{background:#243824}.tab.active{background:#2d5a2d;color:var(--accent);border-color:var(--accent)}
.tab-content{display:none}.tab-content.active{display:block}
.card{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:6px;margin-bottom:10px}
label{display:block;margin:6px 0 2px;color:var(--muted);font-size:11px;text-transform:uppercase}
input,select,textarea{width:100%;padding:6px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:13px}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
textarea{min-height:50px;resize:vertical;font-family:inherit}
button{padding:6px 12px;background:#2d5a2d;border:1px solid var(--accent);color:var(--accent);border-radius:4px;cursor:pointer;font-size:12px}
button:hover{background:#3d6a3d}button:disabled{opacity:0.4}
.btn-primary{background:var(--accent);color:var(--bg);font-weight:600}
.btn-sm{padding:3px 8px;font-size:11px}
.btn-danger{background:#5a2d2d;border-color:var(--danger);color:var(--danger)}
.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px}
.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}.row-4{grid-template-columns:repeat(4,1fr)}.row-5{grid-template-columns:repeat(5,1fr)}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.mt{margin-top:10px}
.img-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;margin-top:10px}
.img-card{background:#1a2e1a;padding:6px;border-radius:4px;text-align:center;position:relative}
.img-card img{width:100%;border-radius:3px;cursor:pointer}
.img-card .actions{display:flex;gap:4px;justify-content:center;margin-top:4px;flex-wrap:wrap}
.img-card .actions button{padding:2px 6px;font-size:10px}
.img-card .info-overlay{position:absolute;bottom:30px;left:0;right:0;background:rgba(0,0,0,0.8);padding:4px;font-size:10px;display:none}
.img-card:hover .info-overlay{display:block}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:9999;justify-content:center;align-items:center;flex-direction:column;gap:10px}
.modal.show{display:flex}
.modal img{max-width:90%;max-height:75%;object-fit:contain}
.modal .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.gallery{column-count:4;column-gap:8px}
.gallery .img-card{break-inside:avoid;margin-bottom:8px}
@media(max-width:900px){.gallery{column-count:3}}
@media(max-width:600px){.gallery{column-count:2}}
.history-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:6px;max-height:400px;overflow-y:auto}
.history-item{background:#1a2e1a;padding:4px;border-radius:4px;cursor:pointer;position:relative}
.history-item img{width:100%;border-radius:3px}
.history-item:hover{outline:2px solid var(--accent)}
.queue-item,.preset-item,.template-item{background:#1a2e1a;padding:8px;border-radius:4px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.preset-item,.template-item{cursor:pointer}
.preset-item:hover,.template-item:hover{background:#243824}
.folder-item{display:inline-block;padding:4px 10px;background:#1a2e1a;border-radius:4px;margin:2px;cursor:pointer}
.folder-item.active{background:#2d5a2d;color:var(--accent)}
#status{font-size:12px;padding:6px 0;color:var(--muted)}
.progress-bar{height:20px;background:var(--bg);border-radius:4px;overflow:hidden;margin:8px 0}
.progress-bar .fill{height:100%;background:var(--accent);transition:width 0.3s}
.progress-bar .text{position:relative;top:-18px;text-align:center;font-size:11px}
.canvas-container{position:relative;display:inline-block;border:1px solid var(--border);border-radius:4px;overflow:hidden;max-width:100%}
.canvas-container canvas{display:block;max-width:100%}
.compare-container{position:relative;width:100%;max-width:600px;overflow:hidden}
.compare-container img{width:100%;display:block}
.compare-container .overlay{position:absolute;top:0;left:0;height:100%;overflow:hidden;border-right:2px solid var(--accent)}
.compare-container input[type=range]{width:100%;margin-top:8px}
.tag{display:inline-block;padding:2px 6px;background:#2d4a2d;border-radius:3px;margin:2px;font-size:11px;cursor:pointer}
.tag:hover{background:var(--accent);color:var(--bg)}
.tag.weighted{background:#4a3d2d}
.autocomplete{position:absolute;background:var(--card);border:1px solid var(--border);border-radius:4px;max-height:200px;overflow-y:auto;z-index:100;width:100%}
.autocomplete div{padding:6px 10px;cursor:pointer}
.autocomplete div:hover{background:#2d5a2d}
.drop-zone{border:2px dashed var(--border);border-radius:6px;padding:20px;text-align:center;color:var(--muted);cursor:pointer}
.drop-zone.dragover{border-color:var(--accent);background:#1a2e1a}
.drop-zone img{max-width:100%;max-height:200px;margin-top:10px}
code{background:#1a2e1a;padding:6px;border-radius:4px;display:block;font-size:11px;color:var(--muted);overflow-x:auto}
.theme-toggle{position:fixed;top:10px;right:10px;z-index:100}
.controlnet-preview{max-width:200px;margin-top:8px}
.weight-slider{display:flex;align-items:center;gap:8px}
.weight-slider input[type=range]{flex:1}
.weight-slider span{min-width:40px}
.syntax-highlight{font-family:monospace}
.syntax-highlight .tag{color:#4ade80}
.syntax-highlight .weight{color:#f0a500}
.syntax-highlight .wildcard{color:#60a5fa}
.lora-browser{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;max-height:300px;overflow-y:auto}
.lora-card{background:#1a2e1a;padding:8px;border-radius:4px;cursor:pointer;text-align:center}
.lora-card:hover{outline:1px solid var(--accent)}
.lora-card img{width:100%;border-radius:3px;margin-bottom:4px}
</style>
</head>
<body>
<button class="theme-toggle btn-sm" onclick="toggleTheme()">üåô</button>
<div class="container">
<h1>üé® SD Proxy <span id="progressIndicator" style="display:none">‚è≥</span></h1>
<div class="progress-bar" id="mainProgress" style="display:none"><div class="fill" id="progressFill"></div><div class="text" id="progressText">0%</div></div>

<div class="tabs">
<button class="tab active" onclick="showTab('generate')">Generate</button>
<button class="tab" onclick="showTab('img2img')">Img2Img</button>
<button class="tab" onclick="showTab('inpaint')">Inpaint</button>
<button class="tab" onclick="showTab('outpaint')">Outpaint</button>
<button class="tab" onclick="showTab('upscale')">Upscale</button>
<button class="tab" onclick="showTab('controlnet')">ControlNet</button>
<button class="tab" onclick="showTab('tools')">Tools</button>
<button class="tab" onclick="showTab('promptgen')">Prompt AI</button>
<button class="tab" onclick="showTab('queue')">Queue <span id="queueCount"></span></button>
<button class="tab" onclick="showTab('history')">History</button>
<button class="tab" onclick="showTab('gallery')">Gallery</button>
<button class="tab" onclick="showTab('models')">Models</button>
<button class="tab" onclick="showTab('console')">Console</button>
<button class="tab" onclick="showTab('settings')">Settings</button>
</div>

<!-- Generate Tab -->
<div id="tab-generate" class="tab-content active">
<div class="card">
<div class="row-3">
<div><label>Backend</label><select id="backend" onchange="onBackendChange()">
<option value="local">Local A1111</option><option value="comfyui">ComfyUI</option><option value="pollinations">Pollinations (Free)</option>
<option value="nanogpt">NanoGPT</option><option value="pixai">PixAI</option><option value="stability">Stability AI</option>
<option value="replicate">Replicate</option><option value="fal">Fal.ai</option><option value="together">Together AI</option><option value="custom">Custom</option>
</select></div>
<div><label>API Key</label><input type="password" id="apiKey" placeholder="If required"></div>
<div><label>Model</label><input id="model" list="modelList" placeholder="Model"><datalist id="modelList"></datalist></div>
</div>
<div id="customEndpoint" style="display:none" class="mt"><label>Custom URL</label><input id="customUrl" placeholder="https://api.example.com/v1"></div>

<label>Prompt <span class="flex" style="float:right;gap:4px">
<button class="btn-sm" onclick="enhancePrompt()">‚ú® Enhance</button>
<button class="btn-sm" onclick="showTemplates()">üìù Templates</button>
<button class="btn-sm" onclick="showWildcardHelp()">? Help</button>
</span></label>
<div style="position:relative">
<textarea id="prompt" placeholder="masterpiece, best quality, " oninput="onPromptInput(this)" onkeydown="onPromptKeydown(event)">masterpiece, best quality, highly detailed, </textarea>
<div id="autocomplete" class="autocomplete" style="display:none"></div>
</div>
<div id="promptTags" class="mt"></div>

<label>Negative Prompt</label>
<textarea id="negative" rows="2">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, jpeg artifacts, signature, watermark, blurry, deformed, ugly, duplicate, morbid, mutilated, mutation, disfigured, malformed limbs, extra limbs, fused fingers, too many fingers, long neck</textarea>

<div class="row-5">
<div><label>Width</label><input type="number" id="width" value="512" step="64"></div>
<div><label>Height</label><input type="number" id="height" value="768" step="64"></div>
<div><label>Steps</label><input type="number" id="steps" value="25"></div>
<div><label>CFG</label><input type="number" id="cfg" value="7" step="0.5"></div>
<div><label>Seed</label><input type="number" id="seed" value="-1"></div>
</div>

<div class="row-4">
<div><label>Sampler</label><select id="sampler">
<option value="euler_ancestral">Euler a</option><option value="euler">Euler</option><option value="dpmpp_2m" selected>DPM++ 2M</option><option value="dpmpp_sde">DPM++ SDE</option><option value="ddim">DDIM</option><option value="uni_pc">UniPC</option>
</select></div>
<div><label>Scheduler</label><select id="scheduler">
<option value="karras" selected>Karras</option><option value="normal">Normal</option><option value="exponential">Exponential</option>
</select></div>
<div><label>Style</label><select id="style">
<option value="">None</option><option value="anime, cel shading">Anime</option><option value="photorealistic, 8k uhd">Photorealistic</option>
<option value="digital painting, artstation">Digital Art</option><option value="oil painting, classical">Oil Painting</option>
<option value="watercolor, soft edges">Watercolor</option><option value="pencil sketch, graphite">Sketch</option>
<option value="pixel art, 16-bit">Pixel Art</option><option value="3d render, octane">3D Render</option>
<option value="cyberpunk, neon">Cyberpunk</option><option value="fantasy art, magical">Fantasy</option>
<option value="comic book, halftone">Comic</option><option value="manga style">Manga</option>
<option value="chibi, kawaii">Chibi</option><option value="studio ghibli">Ghibli</option>
<option value="cinematic, movie still">Cinematic</option><option value="dark fantasy, grimdark">Dark Fantasy</option>
<option value="vaporwave, synthwave">Vaporwave</option><option value="noir, high contrast">Film Noir</option>
</select></div>
<div><label>Batch</label><input type="number" id="batch" value="1" min="1" max="4"></div>
</div>

<div class="row-4 mt">
<div><label><input type="checkbox" id="hiresFix"> Hires Fix</label></div>
<div><label><input type="checkbox" id="faceRestore"> Face Restore</label></div>
<div><label><input type="checkbox" id="tiling"> Tiling/Seamless</label></div>
<div><label>Hires Scale</label><input type="number" id="hiresScale" value="1.5" min="1" max="2" step="0.1"></div>
</div>

<label class="mt">Reference Images (up to 15)</label>
<div id="refImagesContainer" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 0;"></div>
<input type="file" id="refImagesInput" accept="image/*" multiple style="display:none">
<button class="btn-sm" onclick="$('refImagesInput').click()">üìé Add Reference Images</button>
<button class="btn-sm" onclick="clearRefImages()">Clear All</button>

<label class="mt">Extra Instructions</label>
<textarea id="extraInstructions" rows="2" placeholder="Additional instructions for the image model (e.g., style guidance, specific details)..."></textarea>

<div class="flex mt">
<button onclick="generate()" id="genBtn" class="btn-primary">Generate (Ctrl+Enter)</button>
<button onclick="interruptGen()" id="interruptBtn" style="display:none" class="btn-danger">‚èπ Stop</button>
<button onclick="addToQueue()">+ Queue</button>
<button onclick="generateMatrix()">Matrix</button>
<button onclick="savePreset()">üíæ Preset</button>
<button onclick="randomSeed()">üé≤</button>
</div>
<div id="status"></div>
</div>
<div id="result" class="img-grid"></div>
</div>

<!-- Img2Img Tab -->
<div id="tab-img2img" class="tab-content">
<div class="card">
<label>Source Image</label>
<div class="drop-zone" id="img2imgDrop" onclick="$('img2imgFile').click()">
Drop image or click to upload<input type="file" id="img2imgFile" accept="image/*" style="display:none" onchange="loadImg2Img(this)">
<img id="img2imgPreview" style="display:none">
</div>
<div class="row-3 mt">
<div><label>Strength</label><input type="range" id="img2imgStrength" min="0" max="1" step="0.05" value="0.75" oninput="this.nextElementSibling.textContent=this.value"><span>0.75</span></div>
<div><label>Resize</label><select id="resizeMode"><option value="0">Just Resize</option><option value="1">Crop & Resize</option><option value="2">Resize & Fill</option></select></div>
<div class="mt"><button onclick="generateImg2Img()" class="btn-primary">Generate</button></div>
</div>
</div>
<div id="img2imgResult" class="img-grid"></div>
</div>

<!-- Inpaint Tab -->
<div id="tab-inpaint" class="tab-content">
<div class="card">
<label>Source Image</label>
<div class="drop-zone" id="inpaintDrop" onclick="$('inpaintFile').click()">
Drop image or click<input type="file" id="inpaintFile" accept="image/*" style="display:none" onchange="loadInpaint(this)">
</div>
<div class="canvas-container mt" id="inpaintContainer" style="display:none"><canvas id="inpaintCanvas"></canvas></div>
<div class="flex mt">
<label>Brush: <input type="range" id="brushSize" min="5" max="100" value="30" style="width:100px"></label>
<button onclick="clearMask()" class="btn-sm">Clear</button>
<button onclick="invertMask()" class="btn-sm">Invert</button>
</div>
<div class="row-3 mt">
<div><label>Fill</label><select id="inpaintFill"><option value="0">Fill</option><option value="1" selected>Original</option><option value="2">Latent Noise</option></select></div>
<div><label>Strength</label><input type="range" id="inpaintStrength" min="0" max="1" step="0.05" value="0.75" oninput="this.nextElementSibling.textContent=this.value"><span>0.75</span></div>
<div class="mt"><button onclick="generateInpaint()" class="btn-primary">Inpaint</button></div>
</div>
</div>
<div id="inpaintResult" class="img-grid"></div>
</div>

<!-- Outpaint Tab -->
<div id="tab-outpaint" class="tab-content">
<div class="card">
<label>Source Image</label>
<div class="drop-zone" id="outpaintDrop" onclick="$('outpaintFile').click()">
Drop image<input type="file" id="outpaintFile" accept="image/*" style="display:none" onchange="loadOutpaint(this)">
<img id="outpaintPreview" style="display:none">
</div>
<div class="row-2 mt">
<div><label>Pixels to Extend</label><input type="number" id="outpaintPixels" value="128" step="64"></div>
<div><label>Direction</label>
<div class="flex"><label><input type="checkbox" id="outLeft" checked> Left</label><label><input type="checkbox" id="outRight" checked> Right</label>
<label><input type="checkbox" id="outUp" checked> Up</label><label><input type="checkbox" id="outDown" checked> Down</label></div>
</div>
</div>
<button onclick="generateOutpaint()" class="btn-primary mt">Outpaint</button>
</div>
<div id="outpaintResult" class="img-grid"></div>
</div>

<!-- Upscale Tab -->
<div id="tab-upscale" class="tab-content">
<div class="card">
<label>Image to Upscale</label>
<div class="drop-zone" id="upscaleDrop" onclick="$('upscaleFile').click()">
Drop image<input type="file" id="upscaleFile" accept="image/*" style="display:none" onchange="loadUpscale(this)">
<img id="upscalePreview" style="display:none">
</div>
<div class="row-2 mt">
<div><label>Scale</label><select id="upscaleScale"><option value="2">2x</option><option value="4">4x</option></select></div>
<div><label>Upscaler</label><select id="upscaler"><option>R-ESRGAN 4x+</option><option>R-ESRGAN 4x+ Anime6B</option><option>ESRGAN_4x</option><option>Lanczos</option></select></div>
</div>
<button onclick="upscaleImage()" class="btn-primary mt">Upscale</button>
</div>
<div id="upscaleResult"></div>
</div>

<!-- ControlNet Tab -->
<div id="tab-controlnet" class="tab-content">
<div class="card">
<label>Control Image</label>
<div class="drop-zone" id="controlnetDrop" onclick="$('controlnetFile').click()">
Drop image<input type="file" id="controlnetFile" accept="image/*" style="display:none" onchange="loadControlNet(this)">
<img id="controlnetPreview" class="controlnet-preview" style="display:none">
</div>
<div class="row-3 mt">
<div><label>Preprocessor</label><select id="cnPreprocessor">
<option value="none">None</option><option value="canny">Canny</option><option value="depth_midas">Depth (MiDaS)</option>
<option value="openpose">OpenPose</option><option value="lineart">Lineart</option><option value="softedge">Soft Edge</option>
<option value="scribble">Scribble</option><option value="tile_resample">Tile</option>
</select></div>
<div><label>Model</label><select id="cnModel">
<option value="control_v11p_sd15_canny">Canny</option><option value="control_v11f1p_sd15_depth">Depth</option>
<option value="control_v11p_sd15_openpose">OpenPose</option><option value="control_v11p_sd15_lineart">Lineart</option>
</select></div>
<div><label>Weight</label><input type="range" id="cnWeight" min="0" max="2" step="0.1" value="1" oninput="this.nextElementSibling.textContent=this.value"><span>1</span></div>
</div>
<div class="flex mt">
<button onclick="preprocessControlNet()" class="btn-sm">Preprocess</button>
<button onclick="generateWithControlNet()" class="btn-primary">Generate with ControlNet</button>
</div>
<img id="cnProcessedPreview" class="controlnet-preview mt" style="display:none">
</div>
<div id="controlnetResult" class="img-grid"></div>
</div>

<!-- Tools Tab -->
<div id="tab-tools" class="tab-content">
<div class="card">
<h3>üîß Tools</h3>
<div class="row-2 mt">
<div>
<label>Auto-Caption (BLIP/CLIP)</label>
<div class="drop-zone" onclick="$('captionFile').click()" style="padding:10px">
Drop image<input type="file" id="captionFile" accept="image/*" style="display:none" onchange="captionImage(this)">
</div>
<div id="captionResult" class="mt" style="color:var(--muted)"></div>
</div>
<div>
<label>Image Comparison</label>
<div class="drop-zone" onclick="$('compareFile1').click()" style="padding:10px">
Image 1<input type="file" id="compareFile1" accept="image/*" style="display:none" onchange="loadCompare(1,this)">
</div>
<div class="drop-zone mt" onclick="$('compareFile2').click()" style="padding:10px">
Image 2<input type="file" id="compareFile2" accept="image/*" style="display:none" onchange="loadCompare(2,this)">
</div>
<div class="compare-container mt" id="compareContainer" style="display:none">
<img id="compareImg1"><div class="overlay"><img id="compareImg2"></div>
<input type="range" min="0" max="100" value="50" oninput="updateCompare(this.value)">
</div>
</div>
</div>
<div class="row-2 mt">
<div>
<label>X/Y/Z Plot</label>
<div class="row-3">
<div><label>X Axis</label><select id="xyzX"><option value="">None</option><option value="steps">Steps</option><option value="cfg_scale">CFG</option><option value="sampler">Sampler</option><option value="seed">Seed</option></select></div>
<div><label>Y Axis</label><select id="xyzY"><option value="">None</option><option value="steps">Steps</option><option value="cfg_scale">CFG</option><option value="sampler">Sampler</option></select></div>
<div><label>Z Axis</label><select id="xyzZ"><option value="">None</option><option value="steps">Steps</option><option value="cfg_scale">CFG</option></select></div>
</div>
<input id="xyzXValues" placeholder="X values (comma-separated)" class="mt">
<input id="xyzYValues" placeholder="Y values" class="mt">
<button onclick="generateXYZ()" class="btn-primary mt">Generate X/Y/Z Plot</button>
</div>
<div>
<label>Batch from File</label>
<textarea id="batchPrompts" rows="5" placeholder="One prompt per line"></textarea>
<button onclick="generateBatch()" class="btn-primary mt">Generate All</button>
</div>
</div>
</div>
<div id="toolsResult" class="img-grid"></div>
</div>

<!-- Prompt AI Tab -->
<div id="tab-promptgen" class="tab-content">
<div class="card">
<h3>ü§ñ AI Prompt Generator</h3>
<div class="row-3 mt">
<div><label>Provider</label><select id="llmProvider" onchange="onLLMProviderChange()">
<option value="deepseek">DeepSeek</option>
<option value="openrouter">OpenRouter</option>
<option value="openai">OpenAI</option>
<option value="custom">Custom URL</option>
</select></div>
<div><label>API Key</label><input type="password" id="llmApiKey" placeholder="API Key" onchange="saveLLMSettings();fetchLLMModels()"></div>
<div><label>Model</label><select id="llmModel" onchange="saveLLMSettings()"></select></div>
</div>
<div id="llmCustomUrl" style="display:none" class="mt"><label>Custom URL</label><input id="llmCustomEndpoint" placeholder="https://api.example.com/v1/chat/completions" onchange="saveLLMSettings();fetchLLMModels()"></div>

<label class="mt">Prompt Style</label>
<select id="llmPromptStyle" onchange="saveLLMSettings()">
<option value="tags">Danbooru Tags (anime/illustration)</option>
<option value="natural">Natural Description (realistic/photo)</option>
</select>

<label class="mt">Your Request</label>
<textarea id="llmRequest" rows="3" placeholder="Describe what you want to generate, e.g. 'a girl with red hair in a forest at sunset'"></textarea>

<div class="flex mt">
<button onclick="generateLLMPrompt()" class="btn-primary">‚ú® Generate Prompt</button>
<button onclick="copyToPrompt()" class="btn-sm">‚Üí Use as Prompt</button>
<button onclick="copyToPromptAndGenerate()" class="btn-sm">‚Üí Use & Generate</button>
</div>

<label class="mt">Generated Prompt</label>
<textarea id="llmOutput" rows="4" placeholder="AI-generated prompt will appear here..."></textarea>

<div id="llmChat" class="mt" style="max-height:300px;overflow-y:auto;background:#0d1a0d;padding:10px;border-radius:4px;display:none;"></div>
</div>
</div>

<!-- Queue Tab -->
<div id="tab-queue" class="tab-content">
<div class="card">
<div class="flex"><h3 style="flex:1">Generation Queue</h3><button onclick="processQueue()" class="btn-primary">Process All</button></div>
<div id="queueList" class="mt"></div>
</div>
</div>

<!-- History Tab -->
<div id="tab-history" class="tab-content">
<div class="card">
<div class="flex">
<input id="historySearch" placeholder="Search prompts..." oninput="loadHistory()" style="flex:1">
<button onclick="clearHistory()" class="btn-sm btn-danger">Clear All</button>
</div>
<div class="mt">
<span class="folder-item active" onclick="filterFolder(null)">All</span>
<span id="folderList"></span>
<button class="btn-sm" onclick="createFolder()">+ Folder</button>
</div>
</div>
<div id="historyGrid" class="history-grid"></div>
</div>

<!-- Gallery Tab -->
<div id="tab-gallery" class="tab-content">
<div class="card"><div class="flex">
<h3 style="flex:1">‚≠ê Favorites Gallery</h3>
<button onclick="loadFavorites()" class="btn-sm">Refresh</button>
</div></div>
<div id="galleryGrid" class="gallery"></div>
</div>

<!-- Models Tab -->
<div id="tab-models" class="tab-content">
<div class="card">
<h3>üì¶ Model Management</h3>
<div class="row-2 mt">
<div>
<label>Current Model</label>
<select id="currentModel" onchange="switchModel()"></select>
</div>
<div>
<label>VAE</label>
<select id="currentVae" onchange="switchModel()"><option value="Automatic">Automatic</option></select>
</div>
</div>
<button onclick="refreshA1111Models()" class="btn-sm mt">Refresh from A1111</button>

<h3 class="mt">Download from Civitai</h3>
<input id="civitaiUrl" placeholder="Civitai model URL" class="mt">
<button onclick="downloadCivitai()" class="btn-sm mt">Download</button>
<div id="downloadProgress" class="mt"></div>

<h3 class="mt">LoRA Browser</h3>
<div id="loraBrowser" class="lora-browser"></div>
</div>
</div>

<!-- Console Tab -->
<div id="tab-console" class="tab-content">
<div class="card">
<div class="flex"><h3 style="flex:1">üìã Real-time Logs</h3>
<label><input type="checkbox" id="consoleAutoScroll" checked> Auto-scroll</label>
<button class="btn-sm" onclick="clearConsole()">Clear</button>
</div>
<pre id="consoleOutput" style="background:#0d1a0d;padding:10px;border-radius:4px;height:500px;overflow-y:auto;font-size:11px;font-family:monospace;white-space:pre-wrap;word-break:break-all;margin-top:10px;"></pre>
</div>
</div>

<!-- Settings Tab -->
<div id="tab-settings" class="tab-content">
<div class="card">
<div class="row-2">
<div><label>A1111 URL</label><input id="localUrl" value="http://127.0.0.1:7860" onchange="saveSettings()"></div>
<div><label>ComfyUI URL</label><input id="comfyUrl" value="http://127.0.0.1:8188" onchange="saveSettings()"></div>
</div>
<label class="mt">Default Quality Tags</label>
<input id="qualityTags" value="masterpiece, best quality, highly detailed, " onchange="saveSettings()">

<h3 class="mt">Presets</h3>
<div id="presetList"></div>

<h3 class="mt">Prompt Templates</h3>
<div id="templateList"></div>
<div class="flex mt">
<input id="newTemplateName" placeholder="Template name" style="width:150px">
<input id="newTemplateContent" placeholder="Template content with {variables}" style="flex:1">
<button onclick="saveTemplate()" class="btn-sm">Save</button>
</div>

<h3 class="mt">Cost Tracking</h3>
<div id="costDisplay" style="background:#1a2e1a;padding:8px;border-radius:4px"></div>
<button onclick="resetCosts()" class="btn-sm btn-danger mt">Reset</button>

<h3 class="mt">Keyboard Shortcuts</h3>
<code>Ctrl+Enter: Generate | Ctrl+S: Save Preset | Ctrl+Q: Queue | Escape: Close Modal | ‚Üê‚Üí: Navigate Gallery</code>

<h3 class="mt">Export/Import</h3>
<div class="flex"><button onclick="exportData()">Export All</button><button onclick="$('importFile').click()">Import</button></div>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
</div>
</div>

<!-- Modal -->
<div class="modal" id="modal" onclick="if(event.target===this)closeModal()">
<img id="modalImg">
<div id="modalInfo" style="color:var(--muted);font-size:11px;max-width:80%;text-align:center"></div>
<div class="controls">
<button onclick="prevImage()">‚Üê Prev</button>
<button onclick="downloadImage()">Download</button>
<button onclick="sendToImg2Img()">‚Üí Img2Img</button>
<button onclick="sendToInpaint()">‚Üí Inpaint</button>
<button onclick="sendToUpscale()">‚Üí Upscale</button>
<button onclick="sendToControlNet()">‚Üí ControlNet</button>
<button onclick="generateVariation()">üîÑ Variation</button>
<button onclick="toggleFavorite()">‚≠ê</button>
<button onclick="showMetadata()">üìã Info</button>
<button onclick="nextImage()">Next ‚Üí</button>
<button onclick="closeModal()">Close</button>
</div>
</div>

<!-- Templates Modal -->
<div class="modal" id="templatesModal" onclick="if(event.target===this)this.classList.remove('show')">
<div class="card" style="max-width:500px;max-height:80vh;overflow-y:auto">
<h3>Prompt Templates</h3>
<div id="templatesModalList" class="mt"></div>
</div>
</div>
</div>

<script>
const $=id=>document.getElementById(id);
let settings=JSON.parse(localStorage.getItem('sdproxy_settings')||'{}');
let currentImage=null,currentIndex=0,allImages=[],brushSize=30,inpaintImg=null,maskCanvas=null,maskCtx=null,drawing=false;
let img2imgData=null,outpaintData=null,upscaleData=null,controlnetData=null,controlnetProcessed=null;
let refImages=[];

// Extended Danbooru tags
const TAGS=['1girl','1boy','solo','long_hair','short_hair','blonde_hair','brown_hair','black_hair','white_hair','red_hair','blue_hair','pink_hair','purple_hair','green_hair','multicolored_hair','blue_eyes','red_eyes','green_eyes','brown_eyes','yellow_eyes','purple_eyes','heterochromia','smile','open_mouth','closed_eyes','looking_at_viewer','looking_away','from_behind','from_side','standing','sitting','lying','walking','running','jumping','kneeling','outdoors','indoors','sky','cloud','sun','moon','night','day','sunset','sunrise','rain','snow','wind','water','fire','lightning','forest','mountain','beach','ocean','city','street','room','bedroom','bathroom','kitchen','school','classroom','office','castle','ruins','fantasy','sci-fi','cyberpunk','steampunk','medieval','modern','futuristic','simple_background','white_background','black_background','gradient_background','detailed_background','blurry_background','full_body','upper_body','portrait','cowboy_shot','close-up','wide_shot','dutch_angle','from_above','from_below','pov','dress','shirt','skirt','pants','shorts','jacket','coat','sweater','hoodie','uniform','school_uniform','maid','armor','bikini','swimsuit','underwear','nude','weapon','sword','gun','magic','wings','tail','horns','ears','animal_ears','cat_ears','dog_ears','fox_ears','rabbit_ears','halo','crown','hat','glasses','mask','jewelry','necklace','earrings','bracelet','ring','flower','ribbon','bow','lace','frills','high_heels','boots','barefoot','thighhighs','stockings','pantyhose','gloves','cape','scarf'];

function showTab(id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));$('tab-'+id).classList.add('active');event.target.classList.add('active');}
function showModal(url,info){currentImage=url;$('modalImg').src=url;$('modalInfo').textContent=info||'';$('modal').classList.add('show');currentIndex=allImages.indexOf(url);}
function closeModal(){$('modal').classList.remove('show');}
function prevImage(){if(currentIndex>0){currentIndex--;showModal(allImages[currentIndex]);}}
function nextImage(){if(currentIndex<allImages.length-1){currentIndex++;showModal(allImages[currentIndex]);}}
function onBackendChange(){$('customEndpoint').style.display=$('backend').value==='custom'?'block':'none';}
function randomSeed(){$('seed').value=Math.floor(Math.random()*2147483647);}
function toggleTheme(){document.body.classList.toggle('light-theme');}

function saveSettings(){settings={localUrl:$('localUrl').value,comfyUrl:$('comfyUrl').value,qualityTags:$('qualityTags').value};localStorage.setItem('sdproxy_settings',JSON.stringify(settings));}
function loadSettings(){if(settings.localUrl)$('localUrl').value=settings.localUrl;if(settings.comfyUrl)$('comfyUrl').value=settings.comfyUrl;if(settings.qualityTags)$('qualityTags').value=settings.qualityTags;}

// Wildcard & Matrix
function expandWildcards(text){return text.replace(/\{([^}]+)\}/g,(m,p)=>{const opts=p.split('|');return opts[Math.floor(Math.random()*opts.length)];});}
function expandMatrix(prompt){const m=prompt.match(/\[([^\]]+)\]/g);if(!m)return[prompt];const opts=m.map(x=>x.slice(1,-1).split('|'));const combos=opts.reduce((a,o)=>a.flatMap(x=>o.map(y=>[...x,y])),[[]]); return combos.map(c=>{let r=prompt;m.forEach((x,i)=>r=r.replace(x,c[i]));return r;});}

// Autocomplete
function onPromptInput(el){const val=el.value,pos=el.selectionStart,lastComma=val.lastIndexOf(',',pos-1),word=val.slice(lastComma+1,pos).trim().toLowerCase();
if(word.length<2){$('autocomplete').style.display='none';return;}
const matches=TAGS.filter(t=>t.includes(word)).slice(0,15);
if(!matches.length){$('autocomplete').style.display='none';return;}
$('autocomplete').innerHTML=matches.map(t=>`<div onclick="insertTag('${t}')">${t}</div>`).join('');$('autocomplete').style.display='block';}
function insertTag(tag){const el=$('prompt'),val=el.value,pos=el.selectionStart,lastComma=val.lastIndexOf(',',pos-1);el.value=val.slice(0,lastComma+1)+' '+tag+', '+val.slice(pos);$('autocomplete').style.display='none';el.focus();updatePromptTags();}
function onPromptKeydown(e){if(e.key==='Escape')$('autocomplete').style.display='none';if(e.key==='Tab'&&$('autocomplete').style.display==='block'){e.preventDefault();$('autocomplete').firstChild?.click();}}
function updatePromptTags(){const tags=$('prompt').value.split(',').map(t=>t.trim()).filter(t=>t);$('promptTags').innerHTML=tags.slice(0,20).map(t=>{const w=t.match(/:([0-9.]+)\)$/);return`<span class="tag${w?' weighted':''}" onclick="removeTag('${t}')">${t}</span>`;}).join('');}

function removeTag(tag){$('prompt').value=$('prompt').value.split(',').map(t=>t.trim()).filter(t=>t!==tag).join(', ')+', ';updatePromptTags();}

// Session management
let sessionId=localStorage.getItem('sdproxy_session');
if(!sessionId){fetch('/api/session').then(r=>r.json()).then(d=>{sessionId=d.sessionId;localStorage.setItem('sdproxy_session',sessionId);initSSE();});}else{initSSE();}

function initSSE(){
// Progress tracking
const evtSource=new EventSource('/api/progress/'+sessionId);
evtSource.onmessage=e=>{const d=JSON.parse(e.data);
if(d.type==='generation'){$('mainProgress').style.display='block';$('progressFill').style.width=(d.progress*100)+'%';$('progressText').textContent=Math.round(d.progress*100)+'%';$('progressIndicator').style.display=d.done?'none':'inline';if(d.done)setTimeout(()=>$('mainProgress').style.display='none',1000);}
if(d.type==='download'){$('downloadProgress').textContent=`Downloading: ${Math.round(d.progress*100)}%`;}
if(d.type==='log')appendLog(d.message,d.level);};

// Console logging
const logSource=new EventSource('/api/logs/'+sessionId);
logSource.onmessage=e=>{const d=JSON.parse(e.data);appendLog(d.message,d.level);};
}

function appendLog(msg,level='info'){const el=$('consoleOutput');if(!el)return;const time=new Date().toLocaleTimeString();const color=level==='error'?'#e94560':level==='warn'?'#f0a500':'#c8d6c8';el.innerHTML+=`<span style="color:var(--muted)">[${time}]</span> <span style="color:${color}">${escapeHtml(msg)}</span>\n`;if($('consoleAutoScroll').checked)el.scrollTop=el.scrollHeight;}
function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function clearConsole(){$('consoleOutput').innerHTML='';}

function getHeaders(){const h={'Content-Type':'application/json','X-Backend':$('backend').value,'X-Local-Url':$('localUrl').value,'X-Session-Id':sessionId};if($('apiKey').value)h['Authorization']='Bearer '+$('apiKey').value;if($('backend').value==='custom')h['X-Custom-Url']=$('customUrl').value;return h;}

async function generate(){
    const btn=$('genBtn');btn.disabled=true;$('interruptBtn').style.display='inline';$('status').textContent='‚è≥ Generating...';
    try{
        const style=$('style').value;
        const extra=$('extraInstructions').value;
        const body={prompt:expandWildcards($('prompt').value)+(style?', '+style:'')+(extra?'\n'+extra:''),negative_prompt:$('negative').value,
            width:+$('width').value,height:+$('height').value,steps:+$('steps').value,cfg_scale:+$('cfg').value,
            sampler:$('sampler').value,scheduler:$('scheduler').value,seed:+$('seed').value,n:+$('batch').value,model:$('model').value,
            hires_fix:$('hiresFix').checked,hires_scale:+$('hiresScale').value,face_restore:$('faceRestore').checked,tiling:$('tiling').checked};
        if(refImages.length)body.reference_images=refImages;
        if(body.seed<0)delete body.seed;
        const res=await fetch('/v1/images/generations',{method:'POST',headers:getHeaders(),body:JSON.stringify(body)});
        const data=await res.json();
        if(data.error)throw new Error(data.error);
        if(data.data?.length){
            allImages=data.data.map(d=>d.url||(d.b64_json?.startsWith('data:')?d.b64_json:'data:image/png;base64,'+d.b64_json));
            $('status').textContent='‚úÖ Done';
            $('result').innerHTML=allImages.map((u,i)=>`<div class="img-card"><img src="${u}" onclick="showModal('${u}')">
                <div class="info-overlay">${body.prompt.slice(0,50)}...</div>
                <div class="actions"><button onclick="showModal('${u}')">View</button><button onclick="sendToImg2ImgUrl('${u}')">i2i</button><button onclick="addFavorite('${u}')">‚≠ê</button></div></div>`).join('');
        }
    }catch(e){$('status').textContent='‚ùå '+e.message;}
    btn.disabled=false;$('interruptBtn').style.display='none';
}

async function interruptGen(){await fetch('/api/interrupt',{method:'POST',headers:getHeaders()});$('status').textContent='‚èπ Interrupted';}

// Reference images
function renderRefImages(){$('refImagesContainer').innerHTML=refImages.map((src,i)=>`<div style="position:relative;"><img src="${src}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;"><button onclick="removeRefImage(${i})" style="position:absolute;top:-4px;right:-4px;width:16px;height:16px;border-radius:50%;border:none;background:var(--danger);color:#fff;font-size:10px;cursor:pointer;">√ó</button></div>`).join('');}
function removeRefImage(i){refImages.splice(i,1);renderRefImages();}
function clearRefImages(){refImages=[];renderRefImages();}
$('refImagesInput').onchange=function(){const files=Array.from(this.files);const remaining=15-refImages.length;files.slice(0,remaining).forEach(f=>{const r=new FileReader();r.onload=e=>{refImages.push(e.target.result);renderRefImages();};r.readAsDataURL(f);});this.value='';};

async function generateMatrix(){
    const prompts=expandMatrix($('prompt').value);
    if(prompts.length===1)return generate();
    if(!confirm(`Generate ${prompts.length} images?`))return;
    $('status').textContent=`Generating ${prompts.length} images...`;
    const results=[];
    for(let i=0;i<prompts.length;i++){
        $('status').textContent=`Generating ${i+1}/${prompts.length}...`;
        const body={prompt:prompts[i],negative_prompt:$('negative').value,width:+$('width').value,height:+$('height').value,steps:+$('steps').value,cfg_scale:+$('cfg').value,n:1};
        const res=await fetch('/v1/images/generations',{method:'POST',headers:getHeaders(),body:JSON.stringify(body)});
        const data=await res.json();
        if(data.data?.[0])results.push(data.data[0]);
    }
    allImages=results.map(d=>d.url||'data:image/png;base64,'+d.b64_json);
    $('result').innerHTML=allImages.map(u=>`<div class="img-card"><img src="${u}" onclick="showModal('${u}')"></div>`).join('');
    $('status').textContent='‚úÖ Done';
}

// Img2Img
function loadImg2Img(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{img2imgData=e.target.result;$('img2imgPreview').src=img2imgData;$('img2imgPreview').style.display='block';};r.readAsDataURL(f);}
function sendToImg2ImgUrl(url){img2imgData=url;$('img2imgPreview').src=url;$('img2imgPreview').style.display='block';showTab('img2img');}
async function generateImg2Img(){
    if(!img2imgData)return alert('Upload image first');$('status').textContent='‚è≥ Generating...';
    const body={prompt:expandWildcards($('prompt').value),negative_prompt:$('negative').value,width:+$('width').value,height:+$('height').value,steps:+$('steps').value,cfg_scale:+$('cfg').value,init_image:img2imgData,strength:+$('img2imgStrength').value,resize_mode:+$('resizeMode').value};
    try{const res=await fetch('/v1/images/generations',{method:'POST',headers:getHeaders(),body:JSON.stringify(body)});const data=await res.json();
    if(data.error)throw new Error(data.error);
    $('img2imgResult').innerHTML=data.data.map(d=>`<div class="img-card"><img src="data:image/png;base64,${d.b64_json}" onclick="showModal(this.src)"></div>`).join('');$('status').textContent='‚úÖ Done';
    }catch(e){$('status').textContent='‚ùå '+e.message;}
}

// Inpainting
function loadInpaint(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{
    inpaintImg=new Image();inpaintImg.onload=()=>{const c=$('inpaintCanvas'),ctx=c.getContext('2d');c.width=inpaintImg.width;c.height=inpaintImg.height;ctx.drawImage(inpaintImg,0,0);
    maskCanvas=document.createElement('canvas');maskCanvas.width=inpaintImg.width;maskCanvas.height=inpaintImg.height;maskCtx=maskCanvas.getContext('2d');maskCtx.fillStyle='black';maskCtx.fillRect(0,0,maskCanvas.width,maskCanvas.height);
    $('inpaintContainer').style.display='block';setupInpaint(c,ctx);};inpaintImg.src=e.target.result;};r.readAsDataURL(f);}
function setupInpaint(c,ctx){c.onmousedown=e=>{drawing=true;draw(e,ctx);};c.onmousemove=e=>{if(drawing)draw(e,ctx);};c.onmouseup=()=>drawing=false;c.onmouseleave=()=>drawing=false;}
function draw(e,ctx){const rect=e.target.getBoundingClientRect(),x=(e.clientX-rect.left)*(e.target.width/rect.width),y=(e.clientY-rect.top)*(e.target.height/rect.height),bs=+$('brushSize').value;
ctx.globalCompositeOperation='source-over';ctx.fillStyle='rgba(255,0,0,0.5)';ctx.beginPath();ctx.arc(x,y,bs,0,Math.PI*2);ctx.fill();
maskCtx.fillStyle='white';maskCtx.beginPath();maskCtx.arc(x,y,bs,0,Math.PI*2);maskCtx.fill();}
function clearMask(){if(!inpaintImg)return;$('inpaintCanvas').getContext('2d').drawImage(inpaintImg,0,0);maskCtx.fillStyle='black';maskCtx.fillRect(0,0,maskCanvas.width,maskCanvas.height);}
function invertMask(){const d=maskCtx.getImageData(0,0,maskCanvas.width,maskCanvas.height);for(let i=0;i<d.data.length;i+=4){d.data[i]=255-d.data[i];d.data[i+1]=255-d.data[i+1];d.data[i+2]=255-d.data[i+2];}maskCtx.putImageData(d,0,0);}
async function generateInpaint(){
    if(!inpaintImg||!maskCanvas)return alert('Load image and draw mask');$('status').textContent='‚è≥ Inpainting...';
    const tc=document.createElement('canvas');tc.width=inpaintImg.width;tc.height=inpaintImg.height;tc.getContext('2d').drawImage(inpaintImg,0,0);
    const body={prompt:expandWildcards($('prompt').value),negative_prompt:$('negative').value,init_image:tc.toDataURL(),mask:maskCanvas.toDataURL(),inpaint_fill:+$('inpaintFill').value,strength:+$('inpaintStrength').value,steps:+$('steps').value,cfg_scale:+$('cfg').value};
    try{const res=await fetch('/v1/images/generations',{method:'POST',headers:getHeaders(),body:JSON.stringify(body)});const data=await res.json();
    if(data.error)throw new Error(data.error);
    $('inpaintResult').innerHTML=data.data.map(d=>`<div class="img-card"><img src="data:image/png;base64,${d.b64_json}" onclick="showModal(this.src)"></div>`).join('');$('status').textContent='‚úÖ Done';
    }catch(e){$('status').textContent='‚ùå '+e.message;}
}

// Outpainting
function loadOutpaint(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{outpaintData=e.target.result;$('outpaintPreview').src=outpaintData;$('outpaintPreview').style.display='block';};r.readAsDataURL(f);}
async function generateOutpaint(){
    if(!outpaintData)return alert('Upload image');$('status').textContent='‚è≥ Outpainting...';
    const dirs=[];if($('outLeft').checked)dirs.push('left');if($('outRight').checked)dirs.push('right');if($('outUp').checked)dirs.push('up');if($('outDown').checked)dirs.push('down');
    const body={prompt:expandWildcards($('prompt').value),negative_prompt:$('negative').value,init_image:outpaintData,outpaint:{pixels:+$('outpaintPixels').value,direction:dirs.join(',')}};
    try{const res=await fetch('/v1/images/generations',{method:'POST',headers:getHeaders(),body:JSON.stringify(body)});const data=await res.json();
    if(data.error)throw new Error(data.error);
    $('outpaintResult').innerHTML=data.data.map(d=>`<div class="img-card"><img src="data:image/png;base64,${d.b64_json}" onclick="showModal(this.src)"></div>`).join('');$('status').textContent='‚úÖ Done';
    }catch(e){$('status').textContent='‚ùå '+e.message;}
}

// Upscale
function loadUpscale(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{upscaleData=e.target.result;$('upscalePreview').src=upscaleData;$('upscalePreview').style.display='block';};r.readAsDataURL(f);}
async function upscaleImage(){
    if(!upscaleData)return alert('Upload image');$('status').textContent='‚è≥ Upscaling...';
    try{const res=await fetch('/api/upscale',{method:'POST',headers:getHeaders(),body:JSON.stringify({image:upscaleData.split(',')[1],scale:+$('upscaleScale').value,upscaler:$('upscaler').value})});
    const data=await res.json();if(data.error)throw new Error(data.error);
    $('upscaleResult').innerHTML=`<div class="img-card" style="max-width:100%"><img src="data:image/png;base64,${data.image}" onclick="showModal(this.src)" style="max-width:100%"></div>`;$('status').textContent='‚úÖ Done';
    }catch(e){$('status').textContent='‚ùå '+e.message;}
}

// ControlNet
function loadControlNet(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{controlnetData=e.target.result;$('controlnetPreview').src=controlnetData;$('controlnetPreview').style.display='block';};r.readAsDataURL(f);}
async function preprocessControlNet(){
    if(!controlnetData)return alert('Upload image');$('status').textContent='‚è≥ Preprocessing...';
    try{const res=await fetch('/api/controlnet/preprocess',{method:'POST',headers:getHeaders(),body:JSON.stringify({image:controlnetData.split(',')[1],module:$('cnPreprocessor').value})});
    const data=await res.json();if(data.error)throw new Error(data.error);
    controlnetProcessed='data:image/png;base64,'+data.images[0];$('cnProcessedPreview').src=controlnetProcessed;$('cnProcessedPreview').style.display='block';$('status').textContent='‚úÖ Preprocessed';
    }catch(e){$('status').textContent='‚ùå '+e.message;}
}
async function generateWithControlNet(){
    if(!controlnetData)return alert('Upload control image');$('status').textContent='‚è≥ Generating...';
    const body={prompt:expandWildcards($('prompt').value),negative_prompt:$('negative').value,width:+$('width').value,height:+$('height').value,steps:+$('steps').value,cfg_scale:+$('cfg').value,
        controlnet:{image:(controlnetProcessed||controlnetData).split(',')[1],preprocessor:$('cnPreprocessor').value,model:$('cnModel').value,weight:+$('cnWeight').value}};
    try{const res=await fetch('/v1/images/generations',{method:'POST',headers:getHeaders(),body:JSON.stringify(body)});const data=await res.json();
    if(data.error)throw new Error(data.error);
    $('controlnetResult').innerHTML=data.data.map(d=>`<div class="img-card"><img src="data:image/png;base64,${d.b64_json}" onclick="showModal(this.src)"></div>`).join('');$('status').textContent='‚úÖ Done';
    }catch(e){$('status').textContent='‚ùå '+e.message;}
}

// Tools
async function captionImage(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=async e=>{
    $('captionResult').textContent='Analyzing...';
    try{const res=await fetch('/api/interrogate',{method:'POST',headers:getHeaders(),body:JSON.stringify({image:e.target.result.split(',')[1],model:'clip'})});
    const data=await res.json();$('captionResult').textContent=data.caption||data.error;}catch(e){$('captionResult').textContent='Error: '+e.message;}};r.readAsDataURL(f);}

let compareImg1=null,compareImg2=null;
function loadCompare(n,input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{
    if(n===1){compareImg1=e.target.result;$('compareImg1').src=compareImg1;}else{compareImg2=e.target.result;$('compareImg2').src=compareImg2;}
    if(compareImg1&&compareImg2)$('compareContainer').style.display='block';};r.readAsDataURL(f);}
function updateCompare(v){$('compareContainer').querySelector('.overlay').style.width=v+'%';}

async function generateXYZ(){
    const xParam=$('xyzX').value,yParam=$('xyzY').value,xVals=$('xyzXValues').value.split(',').map(v=>v.trim()).filter(v=>v),yVals=$('xyzYValues').value.split(',').map(v=>v.trim()).filter(v=>v);
    if(!xParam||!xVals.length)return alert('Set X axis');
    const baseParams={prompt:$('prompt').value,negative_prompt:$('negative').value,width:+$('width').value,height:+$('height').value,steps:+$('steps').value,cfg_scale:+$('cfg').value,backend:$('backend').value};
    $('status').textContent='Generating X/Y plot...';
    try{const res=await fetch('/api/xyz-plot',{method:'POST',headers:getHeaders(),body:JSON.stringify({baseParams,xAxis:{param:xParam,values:xVals},yAxis:yParam?{param:yParam,values:yVals}:null})});
    const data=await res.json();if(data.error)throw new Error(data.error);
    allImages=data.results.flatMap(r=>r.images.map(i=>i.url||'data:image/png;base64,'+i.b64_json));
    $('toolsResult').innerHTML=`<div style="display:grid;grid-template-columns:repeat(${xVals.length},1fr);gap:4px">`+allImages.map(u=>`<div class="img-card"><img src="${u}" onclick="showModal('${u}')"></div>`).join('')+'</div>';
    $('status').textContent='‚úÖ Done';}catch(e){$('status').textContent='‚ùå '+e.message;}
}

async function generateBatch(){
    const prompts=$('batchPrompts').value.split('\n').map(p=>p.trim()).filter(p=>p);
    if(!prompts.length)return alert('Enter prompts');
    $('status').textContent=`Generating ${prompts.length} images...`;
    try{const res=await fetch('/api/batch-file',{method:'POST',headers:getHeaders(),body:JSON.stringify({prompts,baseParams:{negative_prompt:$('negative').value,width:+$('width').value,height:+$('height').value,steps:+$('steps').value,cfg_scale:+$('cfg').value,backend:$('backend').value}})});
    const data=await res.json();if(data.error)throw new Error(data.error);
    allImages=data.results.flatMap(r=>r.images.map(i=>i.url||'data:image/png;base64,'+i.b64_json));
    $('toolsResult').innerHTML=allImages.map(u=>`<div class="img-card"><img src="${u}" onclick="showModal('${u}')"></div>`).join('');
    $('status').textContent='‚úÖ Done';}catch(e){$('status').textContent='‚ùå '+e.message;}
}

async function enhancePrompt(){
    const prompt=$('prompt').value;if(!prompt)return;$('status').textContent='‚ú® Enhancing...';
    try{const res=await fetch('/api/enhance-prompt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt,style:$('style').value})});
    const data=await res.json();if(data.enhanced){$('prompt').value=data.enhanced;updatePromptTags();}$('status').textContent='‚úÖ Enhanced';}catch(e){$('status').textContent='‚ùå '+e.message;}
}

// LLM Prompt Generator
const LLM_ENDPOINTS={deepseek:'https://api.deepseek.com/v1',openrouter:'https://openrouter.ai/api/v1',openai:'https://api.openai.com/v1'};
let llmSettings=JSON.parse(localStorage.getItem('sdproxy_llm')||'{}');

function loadLLMSettings(){if(llmSettings.provider)$('llmProvider').value=llmSettings.provider;if(llmSettings.apiKey)$('llmApiKey').value=llmSettings.apiKey;if(llmSettings.customUrl)$('llmCustomEndpoint').value=llmSettings.customUrl;if(llmSettings.style)$('llmPromptStyle').value=llmSettings.style;onLLMProviderChange();if(llmSettings.model)$('llmModel').value=llmSettings.model;}
function saveLLMSettings(){llmSettings={provider:$('llmProvider').value,apiKey:$('llmApiKey').value,model:$('llmModel').value,customUrl:$('llmCustomEndpoint').value,style:$('llmPromptStyle').value};localStorage.setItem('sdproxy_llm',JSON.stringify(llmSettings));}
function onLLMProviderChange(){const p=$('llmProvider').value;$('llmCustomUrl').style.display=p==='custom'?'block':'none';fetchLLMModels();saveLLMSettings();}

async function fetchLLMModels(){
    const provider=$('llmProvider').value;
    const apiKey=$('llmApiKey').value;
    const baseUrl=provider==='custom'?$('llmCustomEndpoint').value.replace(/\/chat\/completions$/,''):LLM_ENDPOINTS[provider];
    if(!apiKey||!baseUrl){$('llmModel').innerHTML='<option value="">Enter API key first</option>';return;}
    $('llmModel').innerHTML='<option value="">Loading models...</option>';
    try{
        const res=await fetch(baseUrl+'/models',{headers:{'Authorization':`Bearer ${apiKey}`}});
        const data=await res.json();
        const models=(data.data||[]).map(m=>m.id).sort();
        $('llmModel').innerHTML=models.length?models.map(m=>`<option value="${m}">${m}</option>`).join(''):'<option value="">No models found</option>';
        if(llmSettings.model&&models.includes(llmSettings.model))$('llmModel').value=llmSettings.model;
    }catch(e){$('llmModel').innerHTML=`<option value="">Error: ${e.message}</option>`;}
}

async function generateLLMPrompt(){
    const request=$('llmRequest').value;if(!request)return alert('Enter a request');
    const provider=$('llmProvider').value;
    const apiKey=$('llmApiKey').value;if(!apiKey)return alert('Enter API key');
    const model=$('llmModel').value||'gpt-4o-mini';
    const style=$('llmPromptStyle').value;
    const baseUrl=provider==='custom'?$('llmCustomEndpoint').value.replace(/\/chat\/completions$/,''):LLM_ENDPOINTS[provider];
    const endpoint=baseUrl+'/chat/completions';
    if(!baseUrl)return alert('Invalid endpoint');
    
    const sysPrompt=style==='tags'?'You are an expert at creating Danbooru-style image generation prompts. Convert user requests into comma-separated tags. Include character details, pose, expression, clothing, setting, lighting, and quality tags. Output ONLY the tags, no explanation.':'You are an expert at creating natural language image generation prompts. Convert user requests into detailed descriptive paragraphs suitable for photorealistic image generation. Include subject, setting, lighting, mood, camera angle. Output ONLY the description, no explanation.';
    
    $('llmOutput').value='Generating...';
    try{
        const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},body:JSON.stringify({model,messages:[{role:'system',content:sysPrompt},{role:'user',content:request}],max_tokens:500})});
        const data=await res.json();
        if(data.error)throw new Error(data.error.message||JSON.stringify(data.error));
        const output=data.choices?.[0]?.message?.content||'';
        $('llmOutput').value=output.trim();
    }catch(e){$('llmOutput').value='Error: '+e.message;}
}

function copyToPrompt(){const output=$('llmOutput').value;if(output&&!output.startsWith('Error'))$('prompt').value=output;showTab('generate');updatePromptTags();}
function copyToPromptAndGenerate(){copyToPrompt();generate();}

// Queue
async function addToQueue(){const body={prompt:$('prompt').value,negative_prompt:$('negative').value,width:+$('width').value,height:+$('height').value,steps:+$('steps').value,cfg_scale:+$('cfg').value,backend:$('backend').value};
await fetch('/api/queue',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});loadQueue();}
async function loadQueue(){const res=await fetch('/api/queue');const q=await res.json();$('queueCount').textContent=q.length?`(${q.length})`:'';
$('queueList').innerHTML=q.map(i=>`<div class="queue-item"><span>${i.prompt?.slice(0,50)}...</span><button class="btn-sm btn-danger" onclick="removeQueue(${i.id})">√ó</button></div>`).join('')||'<p style="color:var(--muted)">Empty</p>';}
async function removeQueue(id){await fetch('/api/queue/'+id,{method:'DELETE'});loadQueue();}
async function processQueue(){$('status').textContent='‚è≥ Processing...';const res=await fetch('/api/queue/process',{method:'POST',headers:getHeaders()});const r=await res.json();$('status').textContent=`‚úÖ Processed ${r.length} items`;loadQueue();loadHistory();}

// History
let currentFolder=null;
async function loadHistory(){const search=$('historySearch')?.value||'';const res=await fetch(`/api/history?search=${encodeURIComponent(search)}&folder=${currentFolder||''}`);const data=await res.json();
$('historyGrid').innerHTML=data.items.map(h=>{const url=h.images[0]?.url||'data:image/png;base64,'+h.images[0]?.b64_json;return`<div class="history-item" onclick="showModal('${url}','${(h.prompt||'').slice(0,100).replace(/'/g,"\\'")}')"><img src="${url}"></div>`;}).join('')||'<p style="color:var(--muted)">No history</p>';}
async function clearHistory(){if(confirm('Clear all?')){await fetch('/api/history',{method:'DELETE'});loadHistory();}}
function filterFolder(f){currentFolder=f;document.querySelectorAll('.folder-item').forEach(el=>el.classList.remove('active'));event.target.classList.add('active');loadHistory();}
async function createFolder(){const name=prompt('Folder name:');if(name){await fetch('/api/folders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});loadFolders();}}
async function loadFolders(){const res=await fetch('/api/folders');const f=await res.json();$('folderList').innerHTML=f.map(x=>`<span class="folder-item" onclick="filterFolder('${x.name}')">${x.name}</span>`).join('');}

// Favorites/Gallery
async function loadFavorites(){const res=await fetch('/api/favorites');const f=await res.json();allImages=f.map(x=>x.url);
$('galleryGrid').innerHTML=f.map(x=>`<div class="img-card"><img src="${x.url}" onclick="showModal('${x.url}')"><div class="actions"><button onclick="removeFavorite(${x.id})" class="btn-danger btn-sm">√ó</button></div></div>`).join('')||'<p style="color:var(--muted)">No favorites</p>';}
async function addFavorite(url){await fetch('/api/favorites',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})});loadFavorites();}
async function removeFavorite(id){await fetch('/api/favorites/'+id,{method:'DELETE'});loadFavorites();}
function toggleFavorite(){if(currentImage)addFavorite(currentImage);}

// Presets
async function loadPresets(){const res=await fetch('/api/presets');const p=await res.json();
$('presetList').innerHTML=p.map(x=>`<div class="preset-item" onclick='applyPreset(${JSON.stringify(x).replace(/'/g,"&apos;")})'><span>${x.name}</span><button class="btn-sm btn-danger" onclick="event.stopPropagation();deletePreset(${x.id})">√ó</button></div>`).join('')||'<p style="color:var(--muted)">No presets</p>';}
async function savePreset(){const name=prompt('Preset name:');if(!name)return;const p={name,prompt:$('prompt').value,negative:$('negative').value,width:+$('width').value,height:+$('height').value,steps:+$('steps').value,cfg:+$('cfg').value,sampler:$('sampler').value,scheduler:$('scheduler').value,style:$('style').value};
await fetch('/api/presets',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});loadPresets();}
function applyPreset(p){$('prompt').value=p.prompt||'';$('negative').value=p.negative||'';$('width').value=p.width||512;$('height').value=p.height||768;$('steps').value=p.steps||25;$('cfg').value=p.cfg||7;if(p.sampler)$('sampler').value=p.sampler;if(p.scheduler)$('scheduler').value=p.scheduler;if(p.style)$('style').value=p.style;updatePromptTags();}
async function deletePreset(id){await fetch('/api/presets/'+id,{method:'DELETE'});loadPresets();}

// Templates
async function loadTemplates(){const res=await fetch('/api/templates');const t=await res.json();
$('templateList').innerHTML=t.map(x=>`<div class="template-item" onclick="applyTemplate('${x.content.replace(/'/g,"\\'")}')"><span>${x.name}: ${x.content.slice(0,40)}...</span><button class="btn-sm btn-danger" onclick="event.stopPropagation();deleteTemplate(${x.id})">√ó</button></div>`).join('')||'<p style="color:var(--muted)">No templates</p>';}
async function saveTemplate(){const name=$('newTemplateName').value,content=$('newTemplateContent').value;if(!name||!content)return;
await fetch('/api/templates',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,content})});$('newTemplateName').value='';$('newTemplateContent').value='';loadTemplates();}
function applyTemplate(t){$('prompt').value+=' '+t;updatePromptTags();}
async function deleteTemplate(id){await fetch('/api/templates/'+id,{method:'DELETE'});loadTemplates();}
function showTemplates(){$('templatesModal').classList.add('show');$('templatesModalList').innerHTML=$('templateList').innerHTML;}

// Models
async function refreshA1111Models(){try{const res=await fetch('/api/a1111/models',{headers:getHeaders()});const d=await res.json();
$('currentModel').innerHTML=d.models.map(m=>`<option value="${m.title}">${m.model_name}</option>`).join('');
$('currentVae').innerHTML='<option value="Automatic">Automatic</option>'+d.vaes.map(v=>`<option value="${v.model_name}">${v.model_name}</option>`).join('');
$('loraBrowser').innerHTML=d.loras.map(l=>`<div class="lora-card" onclick="insertLora('${l.name}')"><strong>${l.name}</strong></div>`).join('');}catch(e){alert('Error: '+e.message);}}
async function switchModel(){try{await fetch('/api/a1111/model',{method:'POST',headers:getHeaders(),body:JSON.stringify({model:$('currentModel').value,vae:$('currentVae').value})});$('status').textContent='‚úÖ Model switched';}catch(e){$('status').textContent='‚ùå '+e.message;}}
function insertLora(name){$('prompt').value+=` <lora:${name}:0.7>`;updatePromptTags();}
async function downloadCivitai(){const url=$('civitaiUrl').value;if(!url)return;$('downloadProgress').textContent='Starting...';
try{const match=url.match(/models\/(\d+)/);if(!match)throw new Error('Invalid URL');
const infoRes=await fetch(`https://civitai.com/api/v1/models/${match[1]}`);const info=await infoRes.json();const version=info.modelVersions[0];const file=version.files[0];
await fetch('/api/civitai/download',{method:'POST',headers:getHeaders(),body:JSON.stringify({url:file.downloadUrl,filename:file.name})});
$('downloadProgress').textContent='‚úÖ Downloaded: '+file.name;}catch(e){$('downloadProgress').textContent='‚ùå '+e.message;}}

// Costs
async function loadCosts(){const res=await fetch('/api/costs');const c=await res.json();$('costDisplay').innerHTML=`Total: $${c.total.toFixed(4)}<br>${Object.entries(c.byBackend).map(([k,v])=>`${k}: $${v.toFixed(4)}`).join('<br>')}`;}
async function resetCosts(){if(confirm('Reset?')){await fetch('/api/costs',{method:'DELETE'});loadCosts();}}

// Modal actions
function downloadImage(){if(!currentImage)return;const a=document.createElement('a');a.href=currentImage;a.download='image.png';a.click();}
function sendToImg2Img(){if(!currentImage)return;img2imgData=currentImage;$('img2imgPreview').src=currentImage;$('img2imgPreview').style.display='block';showTab('img2img');closeModal();}
function sendToInpaint(){if(!currentImage)return;const img=new Image();img.onload=()=>{inpaintImg=img;const c=$('inpaintCanvas'),ctx=c.getContext('2d');c.width=img.width;c.height=img.height;ctx.drawImage(img,0,0);maskCanvas=document.createElement('canvas');maskCanvas.width=img.width;maskCanvas.height=img.height;maskCtx=maskCanvas.getContext('2d');maskCtx.fillStyle='black';maskCtx.fillRect(0,0,maskCanvas.width,maskCanvas.height);$('inpaintContainer').style.display='block';setupInpaint(c,ctx);};img.src=currentImage;showTab('inpaint');closeModal();}
function sendToUpscale(){if(!currentImage)return;upscaleData=currentImage;$('upscalePreview').src=currentImage;$('upscalePreview').style.display='block';showTab('upscale');closeModal();}
function sendToControlNet(){if(!currentImage)return;controlnetData=currentImage;$('controlnetPreview').src=currentImage;$('controlnetPreview').style.display='block';showTab('controlnet');closeModal();}
async function generateVariation(){if(!currentImage)return;$('status').textContent='üîÑ Generating variation...';img2imgData=currentImage;
const body={prompt:$('prompt').value,negative_prompt:$('negative').value,init_image:currentImage,strength:0.3,width:+$('width').value,height:+$('height').value,steps:+$('steps').value,cfg_scale:+$('cfg').value};
try{const res=await fetch('/v1/images/generations',{method:'POST',headers:getHeaders(),body:JSON.stringify(body)});const data=await res.json();
if(data.data?.[0]){const url='data:image/png;base64,'+data.data[0].b64_json;allImages.push(url);showModal(url);}$('status').textContent='‚úÖ Done';}catch(e){$('status').textContent='‚ùå '+e.message;}}
async function showMetadata(){if(!currentImage)return;try{const res=await fetch('/api/metadata',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:currentImage})});const d=await res.json();alert(d.raw||'No metadata');}catch(e){alert('Error');}}

// Export/Import
function exportData(){const d={settings};const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='sdproxy-backup.json';a.click();}
function importData(input){const f=input.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(d.settings)localStorage.setItem('sdproxy_settings',JSON.stringify(d.settings));alert('Imported');location.reload();}catch{alert('Invalid');}};r.readAsText(f);}

function showWildcardHelp(){alert('Wildcards: {a|b|c} = random pick\\nMatrix: [a|b] [c|d] = generates all 4 combinations\\nWeights: (tag:1.2) = increase weight\\nLoRA: <lora:name:0.7>');}

// Keyboard & Drag-drop
document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key==='Enter'){e.preventDefault();generate();}if(e.ctrlKey&&e.key==='s'){e.preventDefault();savePreset();}if(e.ctrlKey&&e.key==='q'){e.preventDefault();addToQueue();}if(e.key==='Escape')closeModal();if(e.key==='ArrowLeft'&&$('modal').classList.contains('show'))prevImage();if(e.key==='ArrowRight'&&$('modal').classList.contains('show'))nextImage();});
['img2imgDrop','inpaintDrop','outpaintDrop','upscaleDrop','controlnetDrop'].forEach(id=>{const el=$(id);if(!el)return;el.ondragover=e=>{e.preventDefault();el.classList.add('dragover');};el.ondragleave=()=>el.classList.remove('dragover');el.ondrop=e=>{e.preventDefault();el.classList.remove('dragover');const f=e.dataTransfer.files[0];if(f?.type.startsWith('image/')){const input=el.querySelector('input[type=file]');const dt=new DataTransfer();dt.items.add(f);input.files=dt.files;input.dispatchEvent(new Event('change'));}};});

// Init
loadSettings();loadQueue();loadHistory();loadFavorites();loadPresets();loadTemplates();loadFolders();loadCosts();onBackendChange();updatePromptTags();loadLLMSettings();
</script>
</body></html>
